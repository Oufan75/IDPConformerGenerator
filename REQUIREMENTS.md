# Requirements for IDPCalc Conformer Generator

## Objective

The aim of **IDPCalc Conformer Generator** is to provide an updated, modular and extensible platform for the generation of physical and biologically meaningful ensembles of conformers of Intrinsically Disordered Proteins (IDPs) by intelligently narrowing the conformational search space to naturally occurring angles. Selective narrowing is accomplished by curated and directed searching within previously observed conformational occurrences mined from databases. Though, space for *randomness* may be allow to complement the conformational space exploration.

The conformer pools generated by IDPCalc CG are meant to be used in data-driven ensemble selection algorithms, such as ENSEMBLE or the, *currently under development*, IDPCalculator.

IDPCalc Conformer Generator implements different parametrized search and construction approaches. Yet, a main idea sets a **common** ground: backbone (*psi*, *phi* and *omega*) angle sets must be provided in *chunks* of a predefined (user defined) minimum length and not individually for each residue.

The following subsections explain, and propose, the project's implementation.

## Structural Databases

To generate *ab initio* structural conformers of Intrinsically Disordered Proteins,  **IDPCalc Conformer Generator** relies on three _databases_ of three different types:

1. primary sequences
1. secondary structure identity
1. phi, psi, omega angles

These databases are generated by software provided within, and developed for, this repository/project (read further). The source of the information that populates these databases derives from mining the [RCSB PDB DataBank][rcsb] after obtaining a non-redundant set of structures (PDB IDs and chain identifiers) from the [Dubrack Lab: PISCES project][pisces]. We usually selected the *cullpdb_pc90_res2.2_R1.0* subset. However, the process with which the databases are generated allows to seamlessly add other structures that are not contained in the *cullpdb* file or to edit the information in this file freely.

The necessary software resources to download and prepare the databases from a *cullpdb* file are provided by the following Python programs presented in, and developed for, the repository, *at the time of writting not all the listed programs have been written, in those cases links won't work*:

* [idpcalc_pdb_downloader.py][pdbdownloader]
* [idpcalc_pdb2dssp.py][pdb2dssp]
* [idpcalc_pdb_spliter.py][pdbsplitter]
* [idpcalc_pdb_idealizor.py][pdbidealizor]
* [idpcalc_pdb_angle_extract.py][pdbangle]
* [idpcalc_confgen_db_builder.py][dbbuilder]


After construction, the three databases will contain the specified information (sequence, DSSP and angles) for the different PDBIDs/ChainIDs (*cullpdb* entries), also, the three databases will be aligned equally so that a common indexing information can be used transversely across the DBs. A forth database will link the structural information to the PDB/CHAIN identifier. This construction grants traceability throughout the whole process.

The four databases (structure plus indexes) may be text files, binary files or [Python pickled objects][pickle] already structured to integrate the whole project ecosystem, whichever better fits our needs.

Theses databases will be used by *IDPCalculator Conformer Generator* to build the different conformers.

## Conformer Generation Approach

The overall conformer generation approach can be divided into three steps:

1. [Angle search](#angle-search)
1. [Conformer construction](#conformer-construction)
1. [Validation and filtering](#validation-and-filtering)

Decoupling these three steps is essential to allow individual and specific parametrization of all. We envisage the first and third steps to be the one with which the users will interact the most (parameter modulation), while the second step (conformer construction) will execute predefined algorithms.

### Angle Search

The angle search step focus on the search and query of backbone angles from the angle database ([see Structural Databases](#structural-databases)). This search will be defined by the input protein sequence and user assigned and builtin parameters.

Different search/match approaches are implemented to enrich the quality and variety of the results. The different approaches are described in the following subsections.

Ultimately, the Angle Search step builds an sequence-angle map (*to be investigated the better approach*) upon which the [Conformer Construction](#conformer-construction) algorithm will operate.

#### 1. Pure Secondary Structure 

This search is directly matches the secondary structure identity database with the backbone angles for those residues.

Under this approach, conformers are built by using angles from protein chunks of unique secondary structure regions found in the database. The three different secondary structure types are: helices, sheets and loops. **Initially, and generally**, this approach focused only on **loop** regions, however, it can be abstracted out to include helices and sheets, if required.

In other words, given a target protein of 100 residues, unique secondary structure regions (by default *only* loops) are sequentially and randomly selected from the database and their set of angles are used to build the conformer backbone, chunk by chunk. Different regions are concatenated until the length of the target protein is fulfilled.

This is the simplest approach and does not consider residue identity; it only considers angles *consecutiveness* integrity, that is, angles used to build conformers are given as *chunks* of different lengths and NOT as isolated residue angles.

A parameter is defined to specify the percentage of loop/helices/sheets to be included in the search/construction.

##### Secondary Structure Propensity

Secondary structure propensity can be forced upon a sequence region, and specifying its type and the percentage. Angles will be selected from the database and used accordingly during the construction step.

#### 2. Sequence identity match

The primary sequence of a protein as a whole ultimately encodes for its environment-dependent global energy landscape; and, the same principle is valid at a local level, where portions of the primary sequence encode for particular conformational propensities, locally. Therefore, sequence identity matches between the input IDP sequence and the database, and respective angles, might set a favorable initial ground to define an ensemble starting pool.

IDPCalc Conformer Generator will perform string search to identify sequence matches between the input sequence and the database, extracting the angles herein. The new conformer backbone angles are built from the sequence matching angles similarly to what described in [1. Pure Secondary Structure](#1-pure-secondary-structure).

We expect this approach to capture regions that encode simultaneously for multiple secondary structural elements and which combination have functional value; for example, small alpha-helices in between extended loops, strong turns, even small beta-beta patterns.

We acknowledge that IDP sequence patterns and residue population differs from that of folded proteins, however, we do expect a significant amount of matching to render this approach meaningful. **The absence of matching** is, within this context, information rich and can be explored at latter stages of the conformer generation algorithm.

##### Allowing sequence identify mismatches

Because, within some contexts, aminoacids can be replaced by others without expense of the protein's function (hence, in the case under exploration, conformation landscape), it is important to allow mismatch in sequence identity searches. A parameter can be defined to allow the user to specify the maximum percentage of mismatch allowed per *chunk*; recall the minimum size of residues (angles) *chunks* is also defined by the user.

##### Mapped mismatch

In addition to binary mismatch, *i.e.* absolute matches or mismatches, a mismatch map needs to be implemented in the knowledge base of IDPCalc Conformer Generator. Mismatch maps specify interchangeable residues pairs: in other words, allowed residues mismatches. These should not be considered as pure matches, neither as pure mismatches.

A parameter will allow the user to specify the level of matching/mismatching allowed.

Usage of user defined matching maps will be implemented, where user provided maps update the builtin maps.

#### 3. Incorporation of sequence motifs

It is well known and acknowledged that sequence motifs directly encode for biological functionality, however, identification of such motifs in native protein sequences is not trivial. It is **not** the current aim of Conformer Generator to search for unknown motifs in intrinsically disordered protein sequences. But, following the lines of the previous steps, there is a need to implement motif search within the wide scope of conformer generation, in order to pull from the database those motif-related angle chunks and use them in the building steps.  

Technically, motif search can be incorporated in the [mismatch search](#allowing-sequence-identity-mismatch) algorithm because it is governed by the same technical problems: *mismatched identity*. However, there are two considerations that make motif search diverge from *identity mismatch*, these are:

1. some known motifs require high percentage of mismatch, percentages which wouldn't, *a priori*, be allowed in sequence identity searches, and;
2. the identity matches within motifs are not matches of *random* residues, these are actually well defined matches of commonly repeated residues or residue patterns.

These considerations force the implementation of user-driven motif search in IDPCalc Conformer Generator. In other words, allowing the user the possibility to specify motifs to be searched and queried from the database.

##### predefined motifs

Additionally to user input, known IDP motifs can be predefined in the program's knowledge base. Such motifs would be search in both the input sequence and the database and used if a match is found.

### Conformer Construction

Once the sequence/angle map has been created, through the [Angle Search](#angle-search) step, the actual conformer construction can take place.

Conformer construction must be defined by a *reproducibility seed*.

#### 1. Random assignment

A conformer can be built by randomly selecting and combining angle *chunks* from the sequence-angle map obtained by the parametrized and curated search step.

#### 2. Additional approaches

Other approaches can be implemented upon realization during the evolution of the project.

#### 4. Building Sidechains

*to be discussed.*

### Validation and Filtering

We should expect that the proposed conformer construction algorithm generates physically impossible conformations because, for example, of atom clashes.

A post-construction step of **validation** is, therefore, essential to **filter out** those conformations that do not comply with the different builtin checks prior to saving information to disk.

A builtin list of validation checks can be implemented such that only those conformers that pass all the tests are allowed to be written to disk.

A validation list of this kind can be easily expanded in the future to incorporate additional checks and, moreover, the checks can be flagged individually for activation and deactivation through parameters.

## User Interface

User interface should be that of a shell command-line interface. Graphical interfaces can be considered at a latter stage.

### Usage

The following describes examples of usage/parameters:

```
./idpcalc_conformer_generator \
    -i S/F INPUT_SEQUENCE \
    -n # NUMBER_OF_CONFORMERS_TO_GENERATE \
    -m # MINIMUM_PROTEIN_CHUNK_SIZE \
    -s B SEARCH_SEQUENCE_IDENTITY \
    -x % MAXIMUM_ALLOWED_MISMATCH \
    -ma B ALLOW_MAPPED_MISMATCH \
    -mm F MISMATCH_MAP \
    -p F USER_DEFINED_MOTIFS \
    -h % PURE_HELICAL_CHUNKS_PERCENTAGE \
    -e % PURE_SHEET_CHUNKS_PERCENTAGE \
    -l % PURE_LOOP_CHUNK_PERCENTAGE \
    -w F FORCED_SECONDARY_STRUCTURE_PERCENTAGE \
    -f B ACTIVATE_DEACTIVATE_FILTERS
    -f1 B
    -f2 B (...) FLAGS for the different filters
    -o P FOLDER_WHERE_TO_DEPOSIT_THE_STRUCTURES, defaults to CWD

    (other general parameters)

    -t # STRUCTURE_NUMBERING_START \
    -r # REPRODUCIBILITY_SEED \

```
where:
* `S/F`, string or file
* `#`, number
* `B`, boolean
* `%`, number expressing percentage
* `P`, path to folder

[pdbdownloader]: https://github.com/joaomcteixeira/IDPCalcPDBDownloader/blob/master/idpcalc_pdb_downloader.py
[pdb2dssp]: https://github.com/joaomcteixeira/IDPCalcPDBDownloader/blob/master/idpcalc_pdb2dssp.py
[pdbsplitter]: https://github.com/joaomcteixeira/IDPCalcPDBDownloader/
[pdbidealizor]: https://github.com/joaomcteixeira/IDPCalcPDBDownloader/
[pdbangle]: https://github.com/joaomcteixeira/IDPCalcPDBDownloader/
[dbbuilder]: https://github.com/joaomcteixeira/IDPCalcPDBDownloader/
[rcsb]: https://www.rcsb.org/
[pisces]: http://dunbrack.fccc.edu/Guoli/pisces_download.php
[pickle]: https://docs.python.org/3/library/pickle.html
